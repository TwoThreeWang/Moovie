{{ define "content" }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Movie",
  "name": "{{ .Movie.Title }}",
  "image": "{{ .Movie.Poster }}",
  "datePublished": "{{ .Movie.Year }}",
  {{ if .DirectorList }}
  "director": [
    {{ range $index, $d := .DirectorList }}
      {{ if $index }},{{ end }}
      {
        "@type": "Person",
        "name": "{{ $d.Name | js }}"
      }
    {{ end }}
  ],
  {{ end }}
  {{ if .Movie.Rating }}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ .Movie.Rating }}",
    "bestRating": "10",
    "ratingCount": "100"
  },
  {{ end }}
  "description": "{{ .Movie.Summary | js }}"
}
</script>

<div class="movie-page">
    <!-- 主要内容区：左海报+右信息 -->
    <div class="movie-header">
        <!-- 海报 -->
        <div class="movie-poster-col">
            <img src="https://image.baidu.com/search/down?url={{ .Movie.Poster }}" alt="{{ .Movie.Title }}" class="movie-poster-img" onerror="this.onerror=null;this.src='/static/img/placeholder.svg'">
        </div>

        <!-- 信息列 -->
        <div class="movie-info-col">
            <h1 class="movie-name">{{ .Movie.Title }}{{ if .Movie.Year }} <span class="movie-year-text">({{ .Movie.Year }})</span>{{ end }}</h1>

            {{ if .Movie.OriginalTitle }}
            <div class="movie-alt-name">{{ .Movie.OriginalTitle }}</div>
            {{ end }}

            <!-- 详细信息列表 -->
            <div class="movie-attrs">
                {{ if .Movie.Directors }}
                <div class="attr-row">
                    <span class="attr-label">导演:</span>
                    <span class="attr-value">{{ range $i, $d := (jsonUnmarshal .Movie.Directors) }}{{ if $i }} / {{ end }}{{ $d.name }}{{ end }}</span>
                </div>
                {{ end }}

                {{ if .Movie.Actors }}
                <div class="attr-row">
                    <span class="attr-label">主演:</span>
                    <span class="attr-value">{{ range $i, $a := (jsonUnmarshal .Movie.Actors) }}{{ if $i }} / {{ end }}{{ $a.name }}{{ end }}</span>
                </div>
                {{ end }}

                {{ if .Movie.Genres }}
                <div class="attr-row">
                    <span class="attr-label">类型:</span>
                    <span class="attr-value">{{ .Movie.Genres }}</span>
                </div>
                {{ end }}

                {{ if .Movie.Countries }}
                <div class="attr-row">
                    <span class="attr-label">地区:</span>
                    <span class="attr-value">{{ .Movie.Countries }}</span>
                </div>
                {{ end }}

                {{ if .Movie.Duration }}
                <div class="attr-row">
                    <span class="attr-label">片长:</span>
                    <span class="attr-value">{{ .Movie.Duration }}</span>
                </div>
                {{ end }}

                {{ if .Movie.IMDbID }}
                <div class="attr-row">
                    <span class="attr-label">IMDb:</span>
                    <span class="attr-value">{{ .Movie.IMDbID }}</span>
                </div>
                {{ end }}

                {{ if .Movie.DoubanID }}
                <div class="attr-row">
                    <span class="attr-label">豆瓣:</span>
                    <span class="attr-value"><a href="https://movie.douban.com/subject/{{ .Movie.DoubanID }}" target="_blank" rel="noopener nofollow" style="color: #007722; text-decoration: none;">subject/{{ .Movie.DoubanID }}</a></span>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- 评分与操作 -->
        <div class="movie-rating-col">
            {{ if .Movie.Rating }}
            <div class="rating-block">
                <div class="rating-title">豆瓣评分</div>
                <div class="rating-num">{{ .Movie.Rating }}</div>
                <div class="rating-stars">
                    ★★★★★
                </div>
            </div>
            {{ end }}

            <div class="movie-actions">
                {{ template "user_movie_buttons.html" (dict "DoubanID" .Movie.DoubanID "Title" .Movie.Title "Poster" .Movie.Poster "Year" .Movie.Year "IsWish" .IsWish "IsWatched" .IsWatched) }}
            </div>
        </div>
    </div>

    <!-- 剧情简介 -->
    {{ if .Movie.Summary }}
    <div class="movie-section">
        <h2 class="section-title">剧情简介</h2>
        <p class="movie-summary">{{ .Movie.Summary }}</p>
    </div>
    {{ end }}

    <!-- 豆瓣短评 -->
    {{ if .Movie.DoubanID }}
    <div class="movie-section">
        <h2 class="section-title">豆瓣短评</h2>
        <div id="movie-reviews"
             hx-get="/api/htmx/reviews?douban_id={{ .Movie.DoubanID }}"
             hx-trigger="load"
             hx-indicator="#reviews-loading">
            <div id="reviews-loading" class="htmx-indicator movie-search-loading-state">
                <div class="loading-spinner"></div>
                <p>正在加载短评...</p>
            </div>
        </div>
    </div>
    {{ end }}

    <div class="movie-section">
        <h2 class="section-title">站内用户短评</h2>
        <div id="user-comments"
             hx-get="/api/htmx/movie-comments?douban_id={{ .Movie.DoubanID }}"
             hx-trigger="load"
             hx-indicator="#user-comments-loading">
            <div id="user-comments-loading" class="htmx-indicator movie-search-loading-state">
                <div class="loading-spinner"></div>
                <p>正在加载短评...</p>
            </div>
        </div>
    </div>

    <!-- 在线资源 -->
    <div class="movie-section">
        <h2 class="section-title">在线资源</h2>
        <div id="movie-search-results"
             hx-get="/api/htmx/search?kw={{if .SearchTitle }}{{ .SearchTitle }}{{else}}{{ .Movie.Title }}{{end}}&year={{ .Movie.Year }}"
             hx-trigger="load"
             hx-indicator="#movie-search-loading">
            <div id="movie-search-loading" class="htmx-indicator movie-search-loading-state">
                <div class="loading-spinner"></div>
                <p>正在搜索全网资源，请稍候...</p>
            </div>
        </div>
    </div>

    <!-- 相似电影推荐 -->
    <div class="movie-section">
        <h2 class="section-title">喜欢这部剧集的人也喜欢</h2>
        {{ if .SimilarMovies }}
        <div class="similar-movies-grid">
            {{ range .SimilarMovies }}
            <a href="/movie/{{ .DoubanID }}" class="similar-movie-card">
                <div class="similar-movie-poster">
                    <img src="https://image.baidu.com/search/down?url={{ .Poster }}" alt="{{ .Title }}" loading="lazy" onerror="this.onerror=null;this.src='/static/img/placeholder.svg'">
                    {{ if .Rating }}
                    <span class="similar-movie-rating">{{ .Rating }}</span>
                    {{ end }}
                </div>
                <span class="similar-movie-title">{{ .Title }}</span>
            </a>
            {{ end }}
        </div>
        <div class="similar-movies-more">
            <a href="/similar/{{ .Movie.DoubanID }}">查看更多类似《{{ .Movie.Title }}》的电影 ></a>
        </div>
        {{ else }}
        <div class="similar-movies-empty">
            <p>暂无相似电影推荐</p>
        </div>
        {{ end }}
    </div>
</div>

<style>
/* 相似电影推荐样式 - 复用 similar_movies.html 样式 */
.similar-movies-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1.25rem;
}

.similar-movie-card {
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
}

.similar-movie-card:hover .similar-movie-poster img {
    transform: scale(1.03);
}

.similar-movie-card:hover .similar-movie-title {
    color: var(--primary, #6366f1);
}

.similar-movie-poster {
    position: relative;
    aspect-ratio: 2/3;
    overflow: hidden;
    border-radius: 6px;
    background: var(--bg-tertiary, #2a2a3e);
}

.similar-movie-poster img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.25s ease;
}

.similar-movie-rating {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: #facc15;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 4px;
    backdrop-filter: blur(4px);
}

.similar-movie-title {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color 0.2s;
}

.similar-movies-empty {
    text-align: center;
    color: var(--text-muted, #888);
    padding: 3rem;
}

@media (max-width: 1024px) {
    .similar-movies-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
    }
}

@media (max-width: 768px) {
    .similar-movies-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.875rem;
    }
    .similar-movie-title {
        font-size: 0.8125rem;
    }
}

@media (max-width: 480px) {
    .similar-movies-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }
    .similar-movie-title {
        font-size: 0.75rem;
    }
    .similar-movie-rating {
        font-size: 0.6875rem;
        padding: 2px 6px;
    }
}

.similar-movies-more {
    margin-top: 1.5rem;
    text-align: center;
}

.similar-movies-more a {
    display: inline-block;
    color: var(--text-muted);
    font-size: 0.875rem;
    text-decoration: none;
    transition: color 0.2s;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border-radius: 4px;
}

.similar-movies-more a:hover {
    color: var(--primary);
    background: var(--bg-tertiary);
}

/* 电影页面搜索加载状态 - 复用 search 页面样式 */
.movie-search-loading-state {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: var(--text-muted);
}
.movie-search-loading-state.htmx-request {
    display: flex;
}
</style>
{{ end }}
