
{{ define "content" }}
<div class="admin-page">
    <!-- 页面标题和导航 -->
    <div class="admin-header">
        <h1 class="admin-title">用户管理</h1>
        <nav class="admin-tabs">
            <a href="/admin" class="admin-tab">概览</a>
            <a href="/admin/users" class="admin-tab active">用户</a>
            <a href="/admin/feedback" class="admin-tab">反馈</a>
            <a href="/admin/sites" class="admin-tab">资源网</a>
            <a href="/admin/data" class="admin-tab">数据管理</a>
            <a href="/admin/copyright" class="admin-tab">版权限制</a>
            <a href="/admin/category" class="admin-tab">分类过滤</a>
        </nav>
    </div>

    <div class="admin-card">
        <div class="admin-card-header">
            <h3>用户列表</h3>
            <span class="badge">{{ if .Users }}{{ len .Users }}{{ else }}0{{ end }} 位用户</span>
        </div>
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户名</th>
                        <th>邮箱</th>
                        <th>角色</th>
                        <th>注册时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {{ if .Users }}
                    {{ range .Users }}
                    <tr id="user-row-{{ .ID }}">
                        <td><span class="id-badge">{{ .ID }}</span></td>
                        <td class="user-cell">
                            <div class="user-avatar-sm">{{ firstChar .Username }}</div>
                            <span>{{ .Username }}</span>
                        </td>
                        <td>{{ .Email }}</td>
                        <td>
                            <select class="role-select" onchange="updateUserRole({{ .ID }}, this.value)" data-current="{{ .Role }}">
                                <option value="user" {{ if eq .Role "user" }}selected{{ end }}>普通用户</option>
                                <option value="admin" {{ if eq .Role "admin" }}selected{{ end }}>管理员</option>
                            </select>
                        </td>
                        <td>{{ .CreatedAt.Format "2006-01-02" }}</td>
                        <td class="action-cell">
                            <button class="btn btn-danger btn-sm" onclick="deleteUser({{ .ID }}, '{{ .Username }}')">
                                删除
                            </button>
                        </td>
                    </tr>
                    {{ end }}
                    {{ else }}
                    <tr>
                        <td colspan="6" class="empty-cell">暂无用户数据</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function updateUserRole(userId, newRole) {
    try {
        const formData = new FormData();
        formData.append('role', newRole);

        const response = await fetch(`/admin/users/${userId}/role`, {
            method: 'PUT',
            body: formData
        });

        if (response.ok) {
            // 显示成功提示
            showToast('角色已更新');
        } else {
            const data = await response.json();
            alert(data.error || '更新失败');
            // 恢复原来的值
            window.location.reload();
        }
    } catch (error) {
        alert('操作失败：' + error.message);
        window.location.reload();
    }
}

async function deleteUser(userId, username) {
    if (!confirm(`确定要删除用户 "${username}" 吗？此操作不可撤销！`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/users/${userId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // 移除表格行
            const row = document.getElementById(`user-row-${userId}`);
            if (row) {
                row.remove();
            }
            showToast('用户已删除');
        } else {
            const data = await response.json();
            alert(data.error || '删除失败');
        }
    } catch (error) {
        alert('操作失败：' + error.message);
    }
}

function showToast(message) {
    // 简单的 toast 提示
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('show');
    }, 10);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}
</script>
{{ end }}
